---
import HighlightMarker from './HighlightMarker.astro';
import type { ContentData } from '../types';

interface Props {
  process: ContentData['process'];
}

const { process } = Astro.props;

// Определяем позиции для зигзага (слева/справа)
const positions = ['left', 'right', 'left', 'right', 'left', 'right'];
---

<section id="process" class="section bg-peach relative overflow-hidden">
  <div class="container-custom">
    <div class="max-w-5xl mx-auto">
      <h2 class="heading-2 mb-4 text-center text-ink">
        {process.title}
      </h2>
      
      <p class="text-lg text-ink/80 mb-12 leading-relaxed text-center max-w-2xl mx-auto">
        От первого 'хочу изменений' — к опоре и новым привычкам. Шаг за шагом, <HighlightMarker>в вашем темпе</HighlightMarker>.
      </p>
      
      <!-- Desktop: Зигзагообразный путь -->
      <div class="hidden md:block relative py-16" style="min-height: 700px;">
        <!-- SVG путь - зигзаг с широкими сегментами -->
        <div class="absolute inset-0" style="height: 700px;">
          <svg class="w-full h-full" viewBox="0 0 1000 700" preserveAspectRatio="none" style="pointer-events: none; overflow: visible;">
            <!-- Широкая тропинка (фон) -->
            <path 
              d="M 80 100 L 200 100 L 200 200 L 400 200 L 400 100 L 600 100 L 600 200 L 800 200 L 800 100 L 920 100" 
              fill="none" 
              stroke="rgba(199, 215, 201, 0.3)" 
              stroke-width="40"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="process-path-bg"
            />
            <!-- Контур тропинки -->
            <path 
              d="M 80 100 L 200 100 L 200 200 L 400 200 L 400 100 L 600 100 L 600 200 L 800 200 L 800 100 L 920 100" 
              fill="none" 
              stroke="rgba(199, 215, 201, 0.6)" 
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="process-path"
            />
          </svg>
        </div>
        
        <!-- Чекпоинты и карточки -->
        <div class="relative" style="height: 700px;">
          {process.steps.map((step, index) => {
            const position = positions[index];
            // Позиции на зигзаге (в процентах от viewBox 1000x700)
            const xPositions = [80, 200, 400, 600, 800, 920];
            const yPositions = [100, 200, 100, 200, 100, 100];
            const x = xPositions[index];
            const y = yPositions[index];
            
            return (
              <div 
                class={`absolute process-checkpoint process-checkpoint-${index + 1}`}
                style={`left: ${(x / 1000) * 100}%; top: ${(y / 700) * 100}%; transform: translate(-50%, -50%);`}
              >
                <!-- Крупная точка на повороте -->
                <div class="relative z-10">
                  <div class="w-16 h-16 rounded-full bg-aquaSoft border-4 border-base shadow-lg mx-auto flex items-center justify-center">
                    <span class="text-sm text-ink font-medium">
                      {step.number}
                    </span>
                  </div>
                </div>
                
                <!-- Карточка -->
                <div 
                  class={`absolute ${position === 'left' ? 'right-full mr-10' : 'left-full ml-10'} top-1/2 -translate-y-1/2 w-72 process-card`}
                  style="opacity: 0; transform: translateY(20px);"
                >
                  <div class="bg-base/95 rounded-xl p-6 border border-nimbus/30 shadow-md hover:shadow-lg transition-shadow">
                    <h3 class="text-lg font-medium text-ink mb-2">
                      {step.title.includes('встреча-знакомство') ? (
                        <>
                          {step.title.split('встреча-знакомство')[0]}
                          <HighlightMarker>встреча-знакомство</HighlightMarker>
                          {step.title.split('встреча-знакомство')[1]}
                        </>
                      ) : step.title.includes('по желанию') ? (
                        <>
                          {step.title.split('по желанию')[0]}
                          <HighlightMarker>по желанию</HighlightMarker>
                          {step.title.split('по желанию')[1]}
                        </>
                      ) : step.title.includes('Опора') ? (
                        <>
                          <HighlightMarker>Опора</HighlightMarker>
                          {step.title.split('Опора')[1]}
                        </>
                      ) : (
                        step.title
                      )}
                    </h3>
                    <p class="text-sm text-ink/70 leading-relaxed">
                      {step.description}
                      {index === 1 && (
                        <span class="block mt-2">
                          <a href="#contacts" class="text-xs text-ink/60 hover:text-peach underline decoration-peach/50">
                            Записаться
                          </a>
                        </span>
                      )}
                    </p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
      
      <!-- Mobile: вертикальная версия -->
      <div class="md:hidden space-y-8">
        {process.steps.map((step, index) => {
          return (
            <div class="flex gap-4 items-start relative pl-8">
              <!-- Вертикальная линия -->
              {index < process.steps.length - 1 && (
                <div class="absolute left-3 top-8 bottom-0 w-px bg-aquaSoft/40"></div>
              )}
              
              <!-- Точка -->
              <div class="relative z-10 flex-shrink-0">
                <div class="w-6 h-6 rounded-full bg-aquaSoft border-2 border-base shadow-sm flex items-center justify-center">
                  <span class="text-xs text-ink/50 font-light">{step.number}</span>
                </div>
              </div>
              
              <!-- Карточка -->
              <div class="flex-1 bg-base/90 rounded-xl p-4 border border-nimbus/30 shadow-sm">
                <h3 class="text-lg font-medium text-ink mb-2">
                  {step.title.includes('встреча-знакомство') ? (
                    <>
                      {step.title.split('встреча-знакомство')[0]}
                      <HighlightMarker>встреча-знакомство</HighlightMarker>
                      {step.title.split('встреча-знакомство')[1]}
                    </>
                  ) : step.title.includes('по желанию') ? (
                    <>
                      {step.title.split('по желанию')[0]}
                      <HighlightMarker>по желанию</HighlightMarker>
                      {step.title.split('по желанию')[1]}
                    </>
                  ) : step.title.includes('Опора') ? (
                    <>
                      <HighlightMarker>Опора</HighlightMarker>
                      {step.title.split('Опора')[1]}
                    </>
                  ) : (
                    step.title
                  )}
                </h3>
                <p class="text-sm text-ink/70 leading-relaxed">
                  {step.description}
                  {index === 1 && (
                    <span class="block mt-2">
                      <a href="#contacts" class="text-xs text-ink/60 hover:text-peach underline decoration-peach/50">
                        Записаться
                      </a>
                    </span>
                  )}
                </p>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
  
  <style>
    @media (min-width: 768px) {
      .process-checkpoint {
        animation: fadeInUp 0.6s ease-out forwards;
      }
      
      .process-checkpoint-1 { animation-delay: 0.1s; }
      .process-checkpoint-2 { animation-delay: 0.2s; }
      .process-checkpoint-3 { animation-delay: 0.3s; }
      .process-checkpoint-4 { animation-delay: 0.4s; }
      .process-checkpoint-5 { animation-delay: 0.5s; }
      .process-checkpoint-6 { animation-delay: 0.6s; }
      
      .process-card {
        animation: fadeInUp 0.6s ease-out forwards;
      }
      
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .process-path {
        animation: drawPath 1.2s ease-out forwards;
        stroke-dasharray: 1000;
        stroke-dashoffset: 1000;
      }
      
      @keyframes drawPath {
        to {
          stroke-dashoffset: 0;
        }
      }
      
      .process-path-bg {
        animation: drawPathBg 1.5s ease-out forwards;
        stroke-dasharray: 2000;
        stroke-dashoffset: 2000;
      }
      
      @keyframes drawPathBg {
        to {
          stroke-dashoffset: 0;
        }
      }
    }
  </style>
</section>

