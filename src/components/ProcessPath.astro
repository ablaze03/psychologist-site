---
import HighlightMarker from './HighlightMarker.astro';
import type { ContentData } from '../types';
import contentData from '../../content.json';

interface Props {
  process: ContentData['process'];
}

const { process } = Astro.props;
const content = contentData as ContentData;

// Создаём ссылку на Telegram с prefilled текстом
const telegramMessage = "Добрый день! Меня зовут [Имя]. Хочу записаться на онлайн встречу-знакомство (30 мин). Удобные интервалы (по Москве): … Тема запроса (по желанию): …";
const telegramLinkWithMessage = `https://t.me/Irina_Spva?text=${encodeURIComponent(telegramMessage)}`;

// Позиции шагов вдоль змейки (x, y в процентах от viewBox, и позиция текста: 'top' или 'bottom')
const stepPositions = [
  { x: 10, y: 15, textPos: 'top' },    // 01 - левый верх
  { x: 35, y: 12, textPos: 'top' },    // 02 - ближе к центру верх
  { x: 60, y: 20, textPos: 'bottom' }, // 03 - правый верх
  { x: 80, y: 70, textPos: 'top' },    // 04 - правый низ
  { x: 55, y: 75, textPos: 'bottom' }, // 05 - центр низ
  { x: 25, y: 80, textPos: 'top' },    // 06 - левый низ
];
---

<section id="process" class="section bg-white">
  <div class="container-custom">
    <div class="max-w-6xl mx-auto">
      <h2 class="heading-2 mb-4 text-center text-ink">
        {process.title}
      </h2>
      
      <p class="text-base text-ink/70 mb-12 leading-relaxed text-center max-w-2xl mx-auto">
        {process.subtitle}
      </p>
      
      <!-- Desktop: горизонтальная змейка -->
      <div class="hidden md:block relative" style="height: 340px;">
        <!-- SVG змейка -->
        <svg class="w-full h-full" viewBox="0 0 1000 340" preserveAspectRatio="none" style="overflow: visible;">
          <!-- Путь змейки (2-3 витка) -->
          <path 
            d="M 50 50 Q 200 30 350 50 Q 500 70 650 50 Q 800 30 950 50 Q 900 150 750 170 Q 600 190 450 170 Q 300 150 150 170 Q 100 250 200 270 Q 400 290 600 270 Q 800 250 900 270" 
            fill="none" 
            stroke="#111827" 
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="process-snake-path"
          />
          
          <!-- Маленькие круглые маркеры-узлы (2-3 штуки) -->
          <circle cx="350" cy="50" r="6" fill="#111827" />
          <circle cx="600" cy="170" r="6" fill="#111827" />
          <circle cx="400" cy="270" r="6" fill="#111827" />
        </svg>
        
        <!-- Шаги вдоль змейки -->
        {process.steps.map((step, index) => {
          const pos = stepPositions[index];
          const isStep2 = index === 1;
          
          return (
            <div 
              class="absolute process-step"
              style={`left: ${pos.x}%; top: ${pos.y}%; transform: translate(-50%, ${pos.textPos === 'top' ? '-100%' : '0'});`}
            >
              <!-- Номер в кружке на линии -->
              <div class="w-8 h-8 rounded-full border-2 border-ink flex items-center justify-center bg-white mb-2 mx-auto">
                <span class="text-xs font-medium text-ink">{step.number}</span>
              </div>
              
              <!-- Текст шага -->
              <div class={`${pos.textPos === 'top' ? 'mb-2' : 'mt-2'} text-left`} style="min-width: 160px;">
                <h3 class="text-sm font-semibold text-ink mb-1">
                  {step.title}
                </h3>
                <p class="text-xs text-ink/70 leading-relaxed">
                  {isStep2 ? (
                    <>
                      Пишете в{' '}
                      <a 
                        href={telegramLinkWithMessage}
                        class="text-ink underline hover:text-ink/70"
                        target="_blank"
                      >
                        Telegram
                      </a>
                      {' '}— выбираем время.
                    </>
                  ) : (
                    step.description
                  )}
                </p>
              </div>
            </div>
          );
        })}
      </div>
      
      <!-- Mobile: простой вертикальный список -->
      <div class="md:hidden space-y-6">
        {process.steps.map((step, index) => {
          const isStep2 = index === 1;
          
          return (
            <div class="flex gap-4 items-start">
              <!-- Номер -->
              <div class="w-8 h-8 rounded-full border-2 border-ink flex items-center justify-center bg-white flex-shrink-0">
                <span class="text-xs font-medium text-ink">{step.number}</span>
              </div>
              
              <!-- Текст -->
              <div class="flex-1">
                <h3 class="text-sm font-semibold text-ink mb-1">
                  {step.title}
                </h3>
                <p class="text-xs text-ink/70 leading-relaxed">
                  {isStep2 ? (
                    <>
                      Пишете в{' '}
                      <a 
                        href={telegramLinkWithMessage}
                        class="text-ink underline hover:text-ink/70"
                        target="_blank"
                      >
                        Telegram
                      </a>
                      {' '}— выбираем время.
                    </>
                  ) : (
                    step.description
                  )}
                </p>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
  
  <style>
    @media (min-width: 768px) {
      .process-snake-path {
        animation: drawSnake 2s ease-out forwards;
        stroke-dasharray: 3000;
        stroke-dashoffset: 3000;
      }
      
      @keyframes drawSnake {
        to {
          stroke-dashoffset: 0;
        }
      }
      
      .process-step {
        animation: fadeInStep 0.6s ease-out forwards;
        opacity: 0;
      }
      
      .process-step:nth-child(1) { animation-delay: 0.2s; }
      .process-step:nth-child(2) { animation-delay: 0.4s; }
      .process-step:nth-child(3) { animation-delay: 0.6s; }
      .process-step:nth-child(4) { animation-delay: 0.8s; }
      .process-step:nth-child(5) { animation-delay: 1s; }
      .process-step:nth-child(6) { animation-delay: 1.2s; }
      
      @keyframes fadeInStep {
        to {
          opacity: 1;
        }
      }
    }
  </style>
</section>
