---
import HighlightMarker from './HighlightMarker.astro';
import type { ContentData } from '../types';
import contentData from '../../content.json';

interface Props {
  process: ContentData['process'];
}

const { process } = Astro.props;
const content = contentData as ContentData;

// Создаём ссылку на Telegram с prefilled текстом
const telegramMessage = "Добрый день! Меня зовут [Имя]. Хочу записаться на онлайн встречу-знакомство (30 мин). Удобные интервалы (по Москве): … Тема запроса (по желанию): …";
const telegramLinkWithMessage = `https://t.me/Irina_Spva?text=${encodeURIComponent(telegramMessage)}`;

// Определяем позиции для карточек (слева/справа)
const positions = ['left', 'right', 'left', 'right', 'left', 'right'];
---

<section id="process" class="section bg-peach relative overflow-hidden">
  <div class="container-custom">
    <div class="max-w-6xl mx-auto">
      <h2 class="heading-2 mb-4 text-center text-ink">
        {process.title}
      </h2>
      
      <p class="text-lg text-ink/80 mb-16 leading-relaxed text-center max-w-2xl mx-auto">
        От первого 'хочу изменений' — к опоре и новым привычкам. <HighlightMarker>Шаг за шагом</HighlightMarker>, в вашем темпе.
      </p>
      
      <!-- Desktop: Вертикальная секция с извилистой линией в центре -->
      <div class="hidden md:block relative">
        <div class="grid grid-cols-12 gap-8 relative" style="min-height: 1200px;">
          <!-- Извилистая линия-маршрут в центре (колонка 6) -->
          <div class="col-span-12 absolute inset-0 flex justify-center" style="height: 100%;">
            <svg class="w-full h-full max-w-md" viewBox="0 0 200 1200" preserveAspectRatio="none" style="pointer-events: none;">
              <!-- Мягкая извилистая линия -->
              <path 
                d="M 100 50 Q 120 200 100 350 Q 80 500 100 650 Q 120 800 100 950 Q 80 1100 100 1150" 
                fill="none" 
                stroke="rgba(199, 215, 201, 0.5)" 
                stroke-width="3"
                stroke-linecap="round"
                class="process-path"
              />
            </svg>
          </div>
          
          <!-- Чекпоинты и карточки -->
          {process.steps.map((step, index) => {
            const position = positions[index];
            // Позиции по вертикали (равномерно распределены)
            const yPositions = [50, 250, 450, 650, 850, 1050];
            const yPercent = (yPositions[index] / 1200) * 100;
            
            return (
              <div 
                class={`col-span-12 grid grid-cols-12 gap-8 process-checkpoint process-checkpoint-${index + 1}`}
                style={`position: absolute; top: ${yPercent}%; left: 0; right: 0; transform: translateY(-50%);`}
              >
                {position === 'left' ? (
                  <>
                    <!-- Карточка слева (колонки 1-5) -->
                    <div class="col-span-5 col-start-1 process-card" style="opacity: 0; transform: translateX(-20px);">
                      <div class="bg-base/95 rounded-xl p-6 border border-nimbus/30 shadow-md hover:shadow-lg transition-shadow">
                        <h3 class="text-lg font-medium text-ink mb-2">
                          {step.title.includes('встреча-знакомство') ? (
                            <>
                              {step.title.split('встреча-знакомство')[0]}
                              <HighlightMarker>встреча-знакомство</HighlightMarker>
                              {step.title.split('встреча-знакомство')[1]}
                            </>
                          ) : step.title.includes('по желанию') ? (
                            <>
                              {step.title.split('по желанию')[0]}
                              <HighlightMarker>по желанию</HighlightMarker>
                              {step.title.split('по желанию')[1]}
                            </>
                          ) : step.title.includes('Опора') ? (
                            <>
                              <HighlightMarker>Опора</HighlightMarker>
                              {step.title.split('Опора')[1]}
                            </>
                          ) : (
                            step.title
                          )}
                        </h3>
                        <p class="text-sm text-ink/70 leading-relaxed mb-3">
                          {step.description}
                        </p>
                        {index === 1 && (
                          <a 
                            href={telegramLinkWithMessage}
                            class="btn-primary text-sm px-4 py-2 inline-block"
                            target="_blank"
                          >
                            Записаться в Telegram
                          </a>
                        )}
                      </div>
                    </div>
                    <!-- Узел в центре (колонка 6) -->
                    <div class="col-span-2 col-start-6 flex items-center justify-center">
                      <div class="w-12 h-12 rounded-full bg-aquaSoft border-2 border-base shadow-lg flex items-center justify-center z-10 relative" style="border-width: 3px;">
                        <span class="text-sm text-ink font-medium">{step.number}</span>
                      </div>
                    </div>
                    <!-- Пустое место справа (колонки 7-12) -->
                    <div class="col-span-5"></div>
                  </>
                ) : (
                  <>
                    <!-- Пустое место слева (колонки 1-6) -->
                    <div class="col-span-6"></div>
                    <!-- Узел в центре (колонка 7) -->
                    <div class="col-span-2 col-start-7 flex items-center justify-center">
                      <div class="w-12 h-12 rounded-full bg-aquaSoft border-2 border-base shadow-lg flex items-center justify-center z-10 relative" style="border-width: 3px;">
                        <span class="text-sm text-ink font-medium">{step.number}</span>
                      </div>
                    </div>
                    <!-- Карточка справа (колонки 8-12) -->
                    <div class="col-span-5 col-start-8 process-card" style="opacity: 0; transform: translateX(20px);">
                      <div class="bg-base/95 rounded-xl p-6 border border-nimbus/30 shadow-md hover:shadow-lg transition-shadow">
                        <h3 class="text-lg font-medium text-ink mb-2">
                          {step.title.includes('встреча-знакомство') ? (
                            <>
                              {step.title.split('встреча-знакомство')[0]}
                              <HighlightMarker>встреча-знакомство</HighlightMarker>
                              {step.title.split('встреча-знакомство')[1]}
                            </>
                          ) : step.title.includes('по желанию') ? (
                            <>
                              {step.title.split('по желанию')[0]}
                              <HighlightMarker>по желанию</HighlightMarker>
                              {step.title.split('по желанию')[1]}
                            </>
                          ) : step.title.includes('Опора') ? (
                            <>
                              <HighlightMarker>Опора</HighlightMarker>
                              {step.title.split('Опора')[1]}
                            </>
                          ) : (
                            step.title
                          )}
                        </h3>
                        <p class="text-sm text-ink/70 leading-relaxed mb-3">
                          {step.description}
                        </p>
                        {index === 1 && (
                          <a 
                            href={telegramLinkWithMessage}
                            class="btn-primary text-sm px-4 py-2 inline-block"
                            target="_blank"
                          >
                            Записаться в Telegram
                          </a>
                        )}
                      </div>
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>
      
      <!-- Mobile: вертикальная версия -->
      <div class="md:hidden space-y-8">
        {process.steps.map((step, index) => {
          return (
            <div class="flex gap-4 items-start relative pl-8">
              <!-- Вертикальная линия -->
              {index < process.steps.length - 1 && (
                <div class="absolute left-3 top-8 bottom-0 w-px bg-aquaSoft/40"></div>
              )}
              
              <!-- Узел -->
              <div class="relative z-10 flex-shrink-0">
                <div class="w-8 h-8 rounded-full bg-aquaSoft border-2 border-base shadow-md flex items-center justify-center" style="border-width: 3px;">
                  <span class="text-xs text-ink font-medium">{step.number}</span>
                </div>
              </div>
              
              <!-- Карточка -->
              <div class="flex-1 bg-base/95 rounded-xl p-5 border border-nimbus/30 shadow-md">
                <h3 class="text-lg font-medium text-ink mb-2">
                  {step.title.includes('встреча-знакомство') ? (
                    <>
                      {step.title.split('встреча-знакомство')[0]}
                      <HighlightMarker>встреча-знакомство</HighlightMarker>
                      {step.title.split('встреча-знакомство')[1]}
                    </>
                  ) : step.title.includes('по желанию') ? (
                    <>
                      {step.title.split('по желанию')[0]}
                      <HighlightMarker>по желанию</HighlightMarker>
                      {step.title.split('по желанию')[1]}
                    </>
                  ) : step.title.includes('Опора') ? (
                    <>
                      <HighlightMarker>Опора</HighlightMarker>
                      {step.title.split('Опора')[1]}
                    </>
                  ) : (
                    step.title
                  )}
                </h3>
                <p class="text-sm text-ink/70 leading-relaxed mb-3">
                  {step.description}
                </p>
                {index === 1 && (
                  <a 
                    href={telegramLinkWithMessage}
                    class="btn-primary text-sm px-4 py-2 inline-block"
                    target="_blank"
                  >
                    Записаться в Telegram
                  </a>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
  
  <style>
    @media (min-width: 768px) {
      .process-checkpoint {
        animation: fadeInUp 0.6s ease-out forwards;
      }
      
      .process-checkpoint-1 { animation-delay: 0.1s; }
      .process-checkpoint-2 { animation-delay: 0.2s; }
      .process-checkpoint-3 { animation-delay: 0.3s; }
      .process-checkpoint-4 { animation-delay: 0.4s; }
      .process-checkpoint-5 { animation-delay: 0.5s; }
      .process-checkpoint-6 { animation-delay: 0.6s; }
      
      .process-card {
        animation: fadeInCard 0.6s ease-out forwards;
      }
      
      @keyframes fadeInUp {
        to {
          opacity: 1;
        }
      }
      
      @keyframes fadeInCard {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      .process-path {
        animation: drawPath 1.5s ease-out forwards;
        stroke-dasharray: 2000;
        stroke-dashoffset: 2000;
      }
      
      @keyframes drawPath {
        to {
          stroke-dashoffset: 0;
        }
      }
    }
  </style>
</section>
